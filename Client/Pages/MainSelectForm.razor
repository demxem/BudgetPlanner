@inject Client.Services.IncomeApiClient incomeApiClient
@inject Client.Services.SavingsApiClient savingsApiClient
@inject Client.Services.ExpensesApiClient expensesApiClient
@inject Client.Services.YearApiClient yearsApiClient
@inject Client.Services.DateApiClient dateApiClient
@inject Client.Services.MonthsApiClient monthsApiClient
@inject Client.Services.DetailedBudgetApiClient detailedBudgetApiClient
@using Client.Models
@inject Client.Services.SharedState state
@inject IMessageService MessageService


<MudDialog>
    <DialogContent>
        <MudSelect T="YearModel" Label="Select Year" @Value="@selectedYear"
            ValueChanged="(year => SetYearOnSelect(year))" AnchorOrigin="Origin.BottomCenter">
            @foreach (var year in Years)
            {
                <MudSelectItem Value="@year">@year.Name</MudSelectItem>
            }
        </MudSelect>
        <MudSelect T="string" Label="Months" @bind-Value="@selectedMonth" AnchorOrigin="Origin.BottomCenter">
            <MudSelectItem Value="@("January")" />
            <MudSelectItem Value="@("February")" />
            <MudSelectItem Value="@("March")" />
            <MudSelectItem Value="@("April")" />
            <MudSelectItem Value="@("May")" />
            <MudSelectItem Value="@("June")" />
            <MudSelectItem Value="@("July")" />
            <MudSelectItem Value="@("August")" />
            <MudSelectItem Value="@("September")" />
            <MudSelectItem Value="@("October")" />
            <MudSelectItem Value="@("November")" />
            <MudSelectItem Value="@("Descember")" />
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" @onclick="@SubmitAsync">Ok</MudButton>
    </DialogActions>
</MudDialog>

@code {

    private BudgetModel? filteredIncome;
    private BudgetModel? filteredSavings;
    private BudgetModel? filteredExpenses;

    private string selectedMonth = "";
    private YearModel? selectedYear;
    private string inputYear = "";
    private int selectedYearId;
    private int selectedMonthId;
    private bool dialogSubmit = false;

    private IList<YearModel>? Years = new List<YearModel>();
    private IList<BudgetModel>? IncomeByEachMonth = new List<BudgetModel>();
    private IList<BudgetModel>? SavingsByEachMonth = new List<BudgetModel>();
    private IList<BudgetModel>? ExpensesByEachMonth = new List<BudgetModel>();
    private IList<IncomeModel>? Income = new List<IncomeModel>();
    private IList<BudgetModel>? Months = new List<BudgetModel>();

    [CascadingParameter] MudDialogInstance? MudDialog { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Years = await yearsApiClient.GetYearsAsync();
        Months = await monthsApiClient.GetMonthsAsync();
        IncomeByEachMonth = await incomeApiClient.GetIncomeByEachMonthAsync();
        SavingsByEachMonth = await savingsApiClient.GetSavingByEachMonthAsync();
        ExpensesByEachMonth = await expensesApiClient.GetExpensesByEachMonthAsync();
    }

    private void SetYearOnSelect(YearModel selectedYear)
    {
        selectedYearId = selectedYear.Id;
    }

    private void SubmitAsync()
    {
        FilterIncomeOnSelect();
        FilterSavingsOnSelect();
        FilterExpensesOnSelect();
        state.SelectedIncome = filteredIncome;
        state.SelectedSavings = filteredSavings;
        state.SelectedExpenses = filteredExpenses;
        MudDialog?.Close(DialogResult.Ok(true));
        SendMessage();
    }

    private BudgetModel? FilterIncomeOnSelect()
    {
        FilterMonthOnSelect();
        filteredIncome = IncomeByEachMonth?.Where(i => i.Id == selectedMonthId && i.YearId == selectedYearId).Select(i =>
        i).FirstOrDefault();
        if (filteredIncome == null)
        {
            filteredIncome = new BudgetModel { MonthlyIncome = 0 };
            return filteredIncome;
        }
        return filteredIncome;
    }

    private BudgetModel? FilterSavingsOnSelect()
    {
        FilterMonthOnSelect();
        filteredSavings = SavingsByEachMonth?.Where(s => s.Id == selectedMonthId && s.YearId == selectedYearId).Select(s =>
        s).FirstOrDefault();

        if (filteredSavings == null)
        {
            filteredSavings = new BudgetModel { MonthlySavings = 0 };
            return filteredSavings;
        }
        return filteredSavings;
    }

    private BudgetModel FilterExpensesOnSelect()
    {
        FilterMonthOnSelect();
        filteredExpenses = ExpensesByEachMonth?.Where(e => e.Id == selectedMonthId && e.YearId == selectedYearId).Select(e
        => e).FirstOrDefault();
        if (filteredExpenses == null)
        {
            filteredExpenses = new BudgetModel { MonthlyExpenses = 0 };
            return filteredExpenses;
        }
        return filteredExpenses;
    }

    private void FilterMonthOnSelect()
    {
        selectedMonthId = Months!.Where(m => m.Name == selectedMonth && m.YearId == selectedYearId).Select(m
        => m.Id).FirstOrDefault();
    }
    private void SendMessage()
    {
        MessageService.SendMessage("trackedIncomeSelected");
    }

    private void ClearMessages()
    {
        MessageService.ClearMessages();
    }

    private void Cancel() => MudDialog?.Cancel();

}







